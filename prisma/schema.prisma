// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ---------- ENUMS ----------
enum Role {
  ADMIN
  EMPLOYEE
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  REFUNDED
  CANCELED
}

enum AdChannel {
  FACEBOOK
  TIKTOK
}

// ---------- MODELS ----------
model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  name      String?
  role      Role     @default(EMPLOYEE)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sales     Sale[]
}

model Customer {
  id        String    @id @default(cuid())
  name      String
  phone     String?   @unique
  email     String?   @unique
  address   String?
  tags      String[]
  note      String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  sales     Sale[]
}

model Product {
  id           Int      @id @default(autoincrement())
  code         String   @unique
  name         String
  cost         Decimal  @default(0) @db.Decimal(18, 2)
  price        Decimal  @default(0) @db.Decimal(18, 2)
  stock        Int      @default(0)
  /// ค่าขั้นต่ำของสต็อกที่ต้องการ ถ้าต่ำกว่านี้ให้เตือน
  safetyStock  Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  items        SaleItem[]

  @@index([name])
  @@index([stock])
}

model Sale {
  id            String         @id @default(cuid())
  docNo         String         @unique
  docDate       DateTime
  date          DateTime       @default(now())

  // เก็บค่าเดิมเป็นสตริงเพื่อรองรับข้อมูลเก่า
  customer      String?
  channel       String?

  total         Decimal        @default(0) @db.Decimal(18, 2)
  totalCost     Decimal        @default(0) @db.Decimal(18, 2)
  status        String?
  paymentStatus PaymentStatus  @default(PENDING)

  createdBy     String
  user          User           @relation(fields: [createdBy], references: [id])

  // ความสัมพันธ์กับลูกค้า (อาจว่างสำหรับเรคอร์ดเก่า)
  customerId    String?
  customerRef   Customer?      @relation(fields: [customerId], references: [id])

  // -------- Soft Delete --------
  deletedAt     DateTime?
  deletedBy     String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  items         SaleItem[]

  @@index([createdBy])
  @@index([date])
  @@index([customerId])
  @@index([deletedAt])
}

model SaleItem {
  id        Int     @id @default(autoincrement())
  saleId    String
  productId Int

  qty       Int
  price     Decimal @default(0) @db.Decimal(18, 2)
  discount  Decimal @default(0) @db.Decimal(18, 2)
  amount    Decimal @default(0) @db.Decimal(18, 2)

  costEach  Decimal @default(0) @db.Decimal(18, 2)
  cogs      Decimal @default(0) @db.Decimal(18, 2)

  sale      Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([saleId])
  @@index([productId])
}

model AdSpendDaily {
  id           Int        @id @default(autoincrement())
  date         DateTime   @db.Date
  channel      AdChannel
  campaignName String?
  adsetName    String?
  amount       Decimal    @default(0) @db.Decimal(18, 2)
  createdAt    DateTime   @default(now())

  @@index([date, channel])
}
